name: PR Branch Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branches: [main]

jobs:
  validate-pr-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR source and target branches
        run: |
          # Get source and target branches
          SOURCE_BRANCH="${{ github.head_ref }}"
          TARGET_BRANCH="${{ github.base_ref }}"

          echo "Validating PR from $SOURCE_BRANCH to $TARGET_BRANCH"

          # Extract branch type
          SOURCE_TYPE=$(echo $SOURCE_BRANCH | cut -d'/' -f1)

          # Validate branch relationships based on workflow rules
          # Allowed: feature/*, bugfix/* â†’ main
          # Pre-release branches (alpha, beta, rc) are handled by semantic-release
          if [[ "$SOURCE_TYPE" == "feature" ]] || [[ "$SOURCE_TYPE" == "bugfix" ]]; then
            if [[ "$TARGET_BRANCH" != "main" ]]; then
              echo "ERROR: feature and bugfix branches must target the main branch."
              exit 1
            fi
            echo "PR branch validation passed"

          elif [[ "$SOURCE_BRANCH" == "alpha" ]] || [[ "$SOURCE_BRANCH" == "beta" ]] || [[ "$SOURCE_BRANCH" == "rc" ]]; then
            # Pre-release branches can be merged to main
            if [[ "$TARGET_BRANCH" != "main" ]]; then
              echo "ERROR: pre-release branches (alpha, beta, rc) must target the main branch."
              exit 1
            fi
            echo "PR branch validation passed"

          else
            echo "ERROR: Unknown branch type: $SOURCE_TYPE"
            echo "Allowed branch prefixes: feature/, bugfix/"
            echo "Allowed pre-release branches: alpha, beta, rc"
            exit 1
          fi
